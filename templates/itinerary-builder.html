<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{ trip.name }} - Builder</title>
	<style>
		/* --- CORE STYLES (Kept from your original) --- */
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(to bottom, #0f172a 0%, #1e293b 100%);
			min-height: 100vh;
			color: #fff;
		}

		/* Navbar */
		.navbar {
			background: rgba(15, 23, 42, 0.95);
			backdrop-filter: blur(20px);
			padding: 20px 60px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			border-bottom: 1px solid rgba(255, 255, 255, 0.1);
			position: sticky;
			top: 0;
			z-index: 100;
		}

		.logo {
			font-size: 26px;
			font-weight: 800;
			background: linear-gradient(135deg, #f59e0b, #ef4444);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		.nav-actions {
			display: flex;
			gap: 16px;
			align-items: center;
		}

		.nav-btn {
			padding: 10px 20px;
			border-radius: 10px;
			border: 1px solid rgba(255, 255, 255, 0.2);
			background: rgba(255, 255, 255, 0.05);
			color: white;
			cursor: pointer;
			transition: all 0.3s ease;
			font-weight: 600;
			text-decoration: none;
		}

		.nav-btn:hover {
			background: rgba(255, 255, 255, 0.1);
			transform: translateY(-2px);
		}

		.nav-btn.primary {
			background: linear-gradient(135deg, #f59e0b, #ef4444);
			border: none;
		}

		/* Layout */
		.container {
			display: grid;
			grid-template-columns: 350px 1fr;
			gap: 30px;
			max-width: 1600px;
			margin: 30px auto;
			padding: 0 40px;
			min-height: calc(100vh - 100px);
		}

		/* Sidebar */
		.sidebar {
			background: rgba(30, 41, 59, 0.6);
			backdrop-filter: blur(20px);
			border-radius: 24px;
			padding: 30px;
			border: 1px solid rgba(255, 255, 255, 0.1);
			height: fit-content;
			position: sticky;
			top: 100px;
		}

		.trip-header {
			margin-bottom: 30px;
			padding-bottom: 20px;
			border-bottom: 1px solid rgba(255, 255, 255, 0.1);
		}

		.trip-name {
			font-size: 24px;
			font-weight: 800;
			margin-bottom: 10px;
			background: linear-gradient(135deg, #fff, #e0e0e0);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		.trip-dates {
			font-size: 14px;
			color: #94a3b8;
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.section-title {
			font-size: 16px;
			font-weight: 700;
			margin-bottom: 16px;
			color: #f59e0b;
			text-transform: uppercase;
			letter-spacing: 1px;
		}

		/* Ensure dropdown options have a dark background so they are readable */
		#actCategory option {
			background-color: #1e293b;
			color: white;
		}

		/* Add Stop Search Styles (Added for you) */
		.add-stop-btn {
			width: 100%;
			padding: 16px;
			background: linear-gradient(135deg, #3b82f6, #8b5cf6);
			border: none;
			border-radius: 14px;
			color: white;
			font-weight: 700;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 10px;
			margin-bottom: 20px;
			transition: all 0.3s ease;
		}

		.stop-search-container {
			background: rgba(255, 255, 255, 0.1);
			padding: 15px;
			border-radius: 14px;
			margin-bottom: 20px;
			border: 1px solid rgba(255, 255, 255, 0.2);
			animation: slideDown 0.3s ease-out;
		}

		@keyframes slideDown {
			from {
				opacity: 0;
				transform: translateY(-10px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.stop-search-container input {
			width: 100%;
			padding: 12px;
			border-radius: 8px;
			border: none;
			background: rgba(255, 255, 255, 0.9);
			color: #1e293b;
			font-weight: 600;
		}

		.input-group {
			position: relative;
		}

		.close-search {
			position: absolute;
			right: 10px;
			top: 50%;
			transform: translateY(-50%);
			background: none;
			border: none;
			color: #64748b;
			font-size: 20px;
			cursor: pointer;
		}

		.search-results-list {
			margin-top: 10px;
			max-height: 200px;
			overflow-y: auto;
			background: #1e293b;
			border-radius: 8px;
			border: 1px solid rgba(255, 255, 255, 0.1);
			display: none;
		}

		.search-result-item {
			padding: 10px 14px;
			cursor: pointer;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
			font-size: 14px;
		}

		.search-result-item:hover {
			background: #3b82f6;
			color: white;
		}

		/* Stops List */
		.stops-list {
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.stop-item {
			background: rgba(255, 255, 255, 0.05);
			padding: 16px;
			border-radius: 12px;
			cursor: pointer;
			transition: all 0.3s ease;
			border: 2px solid transparent;
		}

		.stop-item:hover {
			background: rgba(255, 255, 255, 0.08);
			border-color: rgba(59, 130, 246, 0.5);
			transform: translateX(5px);
		}

		.stop-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 8px;
		}

		.stop-city {
			font-weight: 700;
			font-size: 16px;
		}

		.stop-duration {
			font-size: 13px;
			color: #94a3b8;
		}

		/* Main Content */
		.main-content {
			animation: fadeIn 0.8s ease-out;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
			}

			to {
				opacity: 1;
			}
		}

		.content-header {
			background: rgba(30, 41, 59, 0.6);
			backdrop-filter: blur(20px);
			border-radius: 24px;
			padding: 30px;
			margin-bottom: 30px;
			border: 1px solid rgba(255, 255, 255, 0.1);
		}

		.page-title {
			font-size: 36px;
			font-weight: 800;
			margin-bottom: 12px;
		}

		.page-subtitle {
			color: #94a3b8;
			font-size: 16px;
		}

		.builder-container {
			background: rgba(30, 41, 59, 0.6);
			backdrop-filter: blur(20px);
			border-radius: 24px;
			padding: 40px;
			border: 1px solid rgba(255, 255, 255, 0.1);
		}

		/* Day/Stop Section */
		.day-section {
			margin-bottom: 40px;
		}

		.day-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 24px;
			padding: 20px;
			background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
			border-radius: 16px;
			border: 1px solid rgba(59, 130, 246, 0.3);
		}

		.day-title {
			font-size: 24px;
			font-weight: 700;
		}

		.day-date {
			font-size: 14px;
			color: #94a3b8;
		}

		.activities-grid {
			display: grid;
			gap: 16px;
		}

		/* Activity Cards */
		.activity-card {
			background: rgba(255, 255, 255, 0.05);
			padding: 24px;
			border-radius: 16px;
			border: 2px solid rgba(255, 255, 255, 0.1);
			transition: all 0.3s ease;
		}

		.activity-header {
			display: flex;
			justify-content: space-between;
			align-items: start;
			margin-bottom: 12px;
		}

		.activity-name {
			font-size: 18px;
			font-weight: 700;
		}

		.activity-details {
			display: flex;
			gap: 20px;
			margin-top: 12px;
		}

		.activity-detail {
			display: flex;
			align-items: center;
			gap: 8px;
			font-size: 14px;
			color: #94a3b8;
		}

		.activity-cost {
			color: #10b981;
			font-weight: 700;
		}

		.add-activity-card {
			background: rgba(59, 130, 246, 0.1);
			border: 2px dashed rgba(59, 130, 246, 0.4);
			padding: 40px;
			border-radius: 16px;
			text-align: center;
			cursor: pointer;
			transition: all 0.3s ease;
		}

		.add-activity-card:hover {
			background: rgba(59, 130, 246, 0.2);
			border-color: #3b82f6;
		}

		.empty-state {
			text-align: center;
			padding: 40px;
			color: #94a3b8;
		}
	</style>
</head>

<body>
	<nav class="navbar">
		<div class="logo">‚úàÔ∏è GlobeTrotter</div>
		<div class="nav-actions">
			<a href="{{ url_for('dashboard') }}" class="nav-btn">Back to Dashboard</a>
			<a href="{{ url_for('itinerary_view', trip_id=trip.id) }}" class="nav-btn primary"
				style="text-decoration: none; display: inline-block;">
				‚úì Complete Trip
			</a>
		</div>
	</nav>

	<div class="container">
		<aside class="sidebar">
			<div class="trip-header">
				<h2 class="trip-name">{{ trip.name }}</h2>
				<div class="trip-dates">üìÖ {{ trip.start_date }} - {{ trip.end_date }}</div>
			</div>

			<div class="section-title">Your Stops</div>

			<button id="addStopBtn" class="add-stop-btn">
				‚ûï Add New Stop
			</button>
			<div id="stopSearchContainer" class="stop-search-container" style="display: none;">
				<div class="input-group">
					<input type="text" id="citySearchInput" placeholder="Type a city name..." autocomplete="off">
					<button id="closeSearchBtn" class="close-search">√ó</button>
				</div>

				<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
					<div class="input-group">
						<label
							style="font-size: 12px; color: #cbd5e1; margin-bottom: 4px; display: block;">Arrival</label>
						<input type="date" id="stopStartDate"
							style="width: 100%; padding: 10px; border-radius: 8px; border: none;">
					</div>
					<div class="input-group">
						<label
							style="font-size: 12px; color: #cbd5e1; margin-bottom: 4px; display: block;">Departure</label>
						<input type="date" id="stopEndDate"
							style="width: 100%; padding: 10px; border-radius: 8px; border: none;">
					</div>
				</div>

				<div id="searchResults" class="search-results-list"></div>
			</div>
			<div class="stops-list">
				{% for itinerary in trip.itineraries %}
				<div class="stop-item">
					<div class="stop-header">
						<span class="stop-city">üìç {{ itinerary.city_name }}</span>
					</div>
					<div class="stop-duration">{{ itinerary.arrival_date }}</div>
				</div>
				{% else %}
				<div style="color: #94a3b8; font-size: 14px;">No stops added yet.</div>
				{% endfor %}
			</div>

			<div class="quick-stats"
				style="margin-top: 30px; padding: 20px; background: rgba(245, 158, 11, 0.1); border-radius: 14px; border: 1px solid rgba(245, 158, 11, 0.3);">
				<div class="section-title">Trip Budget</div>
				<div style="font-size: 24px; font-weight: 800; color: #f59e0b;">${{ trip.budget_limit }}</div>
			</div>
		</aside>

		<main class="main-content">
			<div class="content-header">
				<h1 class="page-title">Build Your Itinerary</h1>
				<p class="page-subtitle">Add activities and organize your schedule for {{ trip.name }}</p>
			</div>

			<div class="builder-container">
				{% for itinerary in trip.itineraries %}
				<div class="day-section">
					<div class="day-header">
						<div>
							<div class="day-title">Stop {{ loop.index }} - {{ itinerary.city_name }}</div>
							<div class="day-date">{{ itinerary.arrival_date }} to {{ itinerary.departure_date }}</div>
						</div>
					</div>

					<div class="activities-grid">
						{% for activity in itinerary.activities %}
						<div class="activity-card">
							<div class="activity-header">
								<div class="activity-name">{{ activity.title }}</div>
								<div class="activity-cost">{{ activity.currency }} {{ activity.cost }}</div>
							</div>
							<div class="activity-details">
								<div class="activity-detail">üìÇ {{ activity.category }}</div>
								{% if activity.start_time %}
								<div class="activity-detail">‚è∞ {{ activity.start_time }}</div>
								{% endif %}
							</div>
						</div>
						{% else %}
						<div style="color: #94a3b8; font-style: italic; padding: 10px;">No activities added yet.</div>
						{% endfor %}
						<div class="add-activity-card" onclick="openActivityModal('{{ itinerary.id }}')">
							<div style="font-size: 32px; margin-bottom: 10px;">‚ûï</div>
							<div>Add Activity to {{ itinerary.city_name }}</div>
						</div>
					</div>
				</div>
				{% else %}
				<div class="empty-state">
					<h2>Let's start planning! üåç</h2>
					<p>Use the "Add New Stop" button in the sidebar to add your first city.</p>
				</div>
				{% endfor %}
			</div>
		</main>
	</div>


	<!-- This is the modal for "ADD activity" -->
	<div id="activityModal" class="modal-overlay" style="display: none;">
		<div class="modal-content">
			<div class="modal-header">
				<h3>Add New Activity</h3>
				<button onclick="closeActivityModal()" class="close-btn">√ó</button>
			</div>

			<div class="modal-body">
				<input type="hidden" id="currentItineraryId">

				<div class="input-group">
					<label>Activity Name</label>
					<input type="text" id="actTitle" placeholder="e.g., Eiffel Tower Visit">
				</div>

				<div class="row-2">
					<div class="input-group">
						<label>Category</label>
						<select id="actCategory" onchange="toggleOtherCategory(this)"
							style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none;">
							<option value="sightseeing">Sightseeing üì∑</option>
							<option value="food">Food & Dining üçΩÔ∏è</option>
							<option value="transport">Transport üöï</option>
							<option value="accommodation">Accommodation üè®</option>
							<option value="shopping">Shopping üõçÔ∏è</option>
							<option value="other">Other (Custom) ‚úèÔ∏è</option>
						</select>

						<input type="text" id="manualCategory" placeholder="Enter custom category name..."
							style="display: none; margin-top: 10px; border-color: #8b5cf6;">
					</div>
					<div class="input-group">
						<label>Cost</label>
						<input type="number" id="actCost" placeholder="0.00">
					</div>
				</div>



				<div class="row-2">
				</div>

				<div class="input-group" style="margin-bottom: 15px;">
					<label>Activity Date</label>
					<input type="date" id="actDate">
				</div>

				<div class="row-2">
					<div class="input-group">
						<label>Start Time</label>
						<input type="time" id="actTime">
					</div>
					<div class="input-group">
						<label>Duration (mins)</label>
						<input type="number" id="actDuration" placeholder="e.g., 120">
					</div>
				</div>


				<button onclick="saveActivity()" class="save-btn">Save Activity</button>
			</div>
		</div>
	</div>

	<style>
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.7);
			z-index: 1000;
			display: flex;
			justify-content: center;
			align-items: center;
			backdrop-filter: blur(5px);
		}

		.modal-content {
			background: #1e293b;
			padding: 30px;
			border-radius: 16px;
			width: 100%;
			max-width: 500px;
			border: 1px solid rgba(255, 255, 255, 0.1);
			box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
		}

		.modal-header {
			display: flex;
			justify-content: space-between;
			margin-bottom: 20px;
		}

		.close-btn {
			background: none;
			border: none;
			color: #fff;
			font-size: 24px;
			cursor: pointer;
		}

		.row-2 {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 15px;
		}

		.save-btn {
			width: 100%;
			padding: 12px;
			margin-top: 20px;
			background: linear-gradient(135deg, #3b82f6, #8b5cf6);
			border: none;
			border-radius: 8px;
			color: white;
			font-weight: bold;
			cursor: pointer;
		}

		.modal-body input,
		.modal-body select {
			width: 100%;
			padding: 10px;
			margin-bottom: 10px;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 8px;
			color: white;
		}
	</style>

	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const addBtn = document.getElementById('addStopBtn');
			const searchContainer = document.getElementById('stopSearchContainer');
			const closeBtn = document.getElementById('closeSearchBtn');
			const input = document.getElementById('citySearchInput');
			const resultsList = document.getElementById('searchResults');
			let debounceTimer;

			// Toggle Visibility
			addBtn.addEventListener('click', () => {
				addBtn.style.display = 'none';
				searchContainer.style.display = 'block';
				input.focus();
			});

			closeBtn.addEventListener('click', () => {
				searchContainer.style.display = 'none';
				addBtn.style.display = 'flex';
				input.value = '';
				resultsList.style.display = 'none';
			});

			// Handle Typing
			input.addEventListener('input', function () {
				const query = this.value;
				clearTimeout(debounceTimer);
				resultsList.innerHTML = '';

				if (query.length < 3) {
					resultsList.style.display = 'none';
					return;
				}

				debounceTimer = setTimeout(async () => {
					try {
						const res = await fetch(`/api/city-suggestions?query=${query}`);
						const suggestions = await res.json();

						if (suggestions.length > 0) {
							resultsList.style.display = 'block';
							suggestions.forEach(city => {
								const div = document.createElement('div');
								div.className = 'search-result-item';
								div.textContent = city.label;

								// Click to Add Stop
								div.addEventListener('click', () => {
									addCityToItinerary(city);
								});
								resultsList.appendChild(div);
							});
						} else {
							resultsList.style.display = 'none';
						}
					} catch (err) {
						console.error(err);
					}
				}, 300);
			});

			// Add Stop Logic
			async function addCityToItinerary(cityData) {
				// 1. Get Values
				const startDate = document.getElementById('stopStartDate').value;
				const endDate = document.getElementById('stopEndDate').value;

				// 2. Validate
				if (!startDate || !endDate) {
					alert("Please select both Arrival and Departure dates!");
					return;
				}

				// 3. Send Request
				try {
					const res = await fetch(`/api/add-stop/{{ trip.id }}`, {
						method: 'POST',
						headers: {'Content-Type': 'application/json'},
						body: JSON.stringify({
							city_name: cityData.value,
							country: (cityData.label.split(', ')[1] || "Unknown"),
							arrival_date: startDate,   // <--- Sending Manual Date
							departure_date: endDate    // <--- Sending Manual Date
						})
					});

					if (res.ok) {
						window.location.reload();
					} else {
						const data = await res.json();
						alert(`Error: ${data.error}`);
					}
				} catch (err) {
					console.error(err);
					alert("Network Error");
				}
			}
		});

		// Open the modal and remember WHICH stop we are adding to
		function openActivityModal(itineraryId) {
			document.getElementById('currentItineraryId').value = itineraryId;
			document.getElementById('activityModal').style.display = 'flex';
		}

		function closeActivityModal() {
			document.getElementById('activityModal').style.display = 'none';
		}


		function toggleOtherCategory(selectElem) {
			const manualInput = document.getElementById('manualCategory');
			if (selectElem.value === 'other') {
				manualInput.style.display = 'block';
				manualInput.focus();
			} else {
				manualInput.style.display = 'none';
				manualInput.value = ''; // Clear it if they switch back
			}
		}

		async function saveActivity() {
			const itineraryId = document.getElementById('currentItineraryId').value;

			// Check Category Logic
			let categoryValue = document.getElementById('actCategory').value;
			if (categoryValue === 'other') {
				categoryValue = document.getElementById('manualCategory').value;
				if (!categoryValue.trim()) {
					return alert("Please enter a custom category name!");
				}
			}

			const data = {
				title: document.getElementById('actTitle').value,
				category: categoryValue,
				cost: document.getElementById('actCost').value || 0,

				// --- GET THE NEW DATE ---
				activity_date: document.getElementById('actDate').value,

				start_time: document.getElementById('actTime').value,
				duration: document.getElementById('actDuration').value
			};
			if (!data.title) return alert("Please enter a title");

			try {
				const res = await fetch(`/api/add-activity/${itineraryId}`, {
					method: 'POST',
					headers: {'Content-Type': 'application/json'},
					body: JSON.stringify(data)
				});

				if (res.ok) {
					window.location.reload();
				} else {
					alert("Error saving activity");
				}
			} catch (err) {
				console.error(err);
				alert("Network Error");
			}
		}
	</script>
</body>

</html>
